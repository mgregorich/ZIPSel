---
title: "Simulation study - Variable selection for 'too' many zero-inflated predictors (ZIPSel)"
author:
  - name: "Mariella Gregorich"
    affiliation: "Medical University of Vienna, Center for Medical Data Science"
date: last-modified
categories: [2023, simulation study, ZIPSel, R]
description: "Classification: confidential"
editor: visual
theme: cosmo
toc: true  
number-sections: true
colorlinks: true
highlight-style: pygments
format:
  html: 
    code-fold: true
    code-tools: true
    html-math-method: katex
    self-contained: true
---

# Preliminaries

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = F, warning=F, message=F)

source(here::here("src","functions_sim.R"))
source(here::here("src","functions_aux.R"))
#source(here::here("src","setup.R"))

pacman::p_load(ggplot2, parallel, future.apply, stringr, kableExtra,
               openxlsx, dplyr, tidyverse, simdata, looplot)

# Paths
out.path <- "output"
sim.date <- "2023-09-14"
sim.file <- paste0("sim_", sim.date,"/")
sim.path <- here::here(out.path, sim.file)
ggcols <- c("black", "grey45","goldenrod3", "deepskyblue3", "royalblue3", "darkred", "seagreen4")
methnames <- c("oracle", "lasso", "ridge", "ridge-lasso", "lasso-ridge", "ridge-garrote", "random forest")
# Read in results
tbl_res <- readRDS(here::here(sim.path, "tbl_scenario_results.rds"))

tbl_perf <- tbl_res$performance$tbl_perf  %>% 
  mutate(model = fct_relevel(model, methnames))
tbl_iters_perf <- tbl_res$iters$tbl_iters_perf  %>% 
  mutate(model = fct_relevel(model, methnames))
tbl_varsel <- tbl_res$performance$tbl_varsel %>% 
  mutate(model = fct_relevel(model, methnames[2:7]))
tbl_allsel <- tbl_res$performance$tbl_allsel %>% 
  mutate(model = fct_relevel(model, methnames[2:7]))
tbl_groupsel <- tbl_res$performance$tbl_groupsel
```


# Scenario A

:::{.panel-tabset}

## ZI: low
```{r}
tbl_perf %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, revzi, model, penalty, RMSPE.est) %>%
  filter(scenario %in% "A" & penalty %in% c("combined", "-") & propzi == 0.75 & struczero == 0.33 & revzi == TRUE & model != "oracle") %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = RMSPE.est, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="a" ,
                   steps_y_base = -2, steps_y_height = 0.5, grid_rows = "p",
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "Averaged RMSPE",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols,
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(7.5, 7.5),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                           axis.text.x = element_text(size = 14,
                                                      angle = -90,
                                                      vjust = 0.5),
                         legend.position="top")
                   )) 
```

```{r}
tbl_perf %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, revzi, model, penalty, R2.est) %>%
  filter(scenario %in% "A" & penalty %in% c("combined", "-") & propzi == 0.25 & struczero == 0.33 & revzi == FALSE & model != "oracle") %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = R2.est, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="a" ,
                   steps_y_base = -0.05, steps_y_height = 0.05, grid_rows = "p",
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "Averaged R2",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols,
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(0.25, 0.25),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```

```{r}
tbl_perf %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, revzi, model, penalty, CS.est) %>%
  filter(scenario %in% "A" & penalty %in% c("combined", "-") & propzi == 0.25 & struczero == 0.33 & revzi == FALSE) %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = CS.est, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="a" ,
                   steps_y_base = 0, steps_y_height = 0.05, grid_rows = "p",
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "Averaged CS",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols,
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(0.25, 0.25),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```

## ZI: moderate
```{r}
tbl_perf %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, revzi, model, penalty, RMSPE.est) %>%
  filter(scenario %in% "A" & penalty %in% c("combined", "-") & propzi == 0.5 & struczero == 0.33 & revzi == FALSE & model != "oracle") %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = RMSPE.est, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="a" ,
                   steps_y_base = -2, steps_y_height = 0.5, grid_rows = "p",
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "Averaged RMSPE",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols,
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(7.5, 7.5),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```

```{r}
tbl_perf %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, revzi, model, penalty, R2.est) %>%
  filter(scenario %in% "A" & penalty %in% c("combined", "-") & propzi == 0.5 & struczero == 0.33 & revzi == FALSE) %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = R2.est, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="a" ,
                   steps_y_base = -0.05, steps_y_height = 0.05, grid_rows = "p",
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "Averaged R2",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols,
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(0.25, 0.25),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```

```{r}
tbl_perf %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, revzi, model, penalty, CS.est) %>%
  filter(scenario %in% "A" & penalty %in% c("combined", "-") & propzi == 0.5 & struczero == 0.33 & revzi == FALSE & model != "oracle") %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = CS.est, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="a" ,
                   steps_y_base = 0, steps_y_height = 0.05, grid_rows = "p",
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "Averaged CS",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols,
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(0.25, 0.25),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```


## ZI: high
```{r}
tbl_perf %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, revzi, model, penalty, RMSPE.est) %>%
  filter(scenario %in% "A" & penalty %in% c("combined", "-") & propzi == 0.75 & struczero == 0.33 & revzi == FALSE & model != "oracle") %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = RMSPE.est, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="a" ,
                   steps_y_base = -2, steps_y_height = 0.5, grid_rows = "p",
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "Averaged RMSPE",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols,
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(7.5, 7.5),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```

```{r}
tbl_perf %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, revzi, model, penalty, R2.est) %>%
  filter(scenario %in% "A" & penalty %in% c("combined", "-") & propzi == 0.75 & struczero == 0.33 & revzi == FALSE & model != "oracle") %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = R2.est, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="a" ,
                   steps_y_base = -0.05, steps_y_height = 0.05, grid_rows = "p",
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "Averaged R2",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols,
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(0.25, 0.25),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```

```{r}
tbl_perf %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, revzi, model, penalty, CS.est) %>%
  filter(scenario %in% "A" & penalty %in% c("combined", "-") & propzi == 0.75 & struczero == 0.33 & revzi == FALSE ) %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = CS.est, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="a" ,
                   steps_y_base = 0, steps_y_height = 0.05, grid_rows = "p",
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "Averaged CS",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols,
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(0.25, 0.25),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```

:::

# Scenario B

:::{.panel-tabset}

## ZI: low
```{r}
tbl_perf %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, revzi, model, penalty, RMSPE.est) %>%
  filter(scenario %in% "B" & penalty %in% c("combined", "-") & propzi == 0.25 & struczero == 0.33 & revzi == FALSE & model != "oracle") %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = RMSPE.est, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="a" ,
                   steps_y_base = -2, steps_y_height = 0.5, grid_rows = "p",
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "Averaged RMSPE",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols,
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(7.5, 7.5),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```

```{r}
tbl_perf %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, model, penalty, R2.est) %>%
  filter(scenario %in% "B" & penalty %in% c("combined", "-") & propzi == 0.25 & struczero == 0.33) %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = R2.est, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="p" ,
                   steps_y_base = -0.05, steps_y_height = 0.05, grid_rows = "a",
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "Averaged R2",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols,
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(0.25, 0.25),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```

```{r}
tbl_perf %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, model, penalty, CS.est) %>%
  filter(scenario %in% "B" & penalty %in% c("combined", "-") & propzi == 0.25 & struczero == 0.33) %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = CS.est, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="p" ,
                   steps_y_base = 0, steps_y_height = 0.05, grid_rows = "a",
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "Averaged CS",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols,
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(0.25, 0.25),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```

## ZI: moderate
```{r}
tbl_perf %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, model, penalty, RMSPE.est) %>%
  filter(scenario %in% "B" & penalty %in% c("combined", "-") & propzi == 0.5 & struczero == 0.33 & model != "oracle") %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = RMSPE.est, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="p" ,
                   steps_y_base = -2, steps_y_height = 0.5, grid_rows = "a",
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "Averaged RMSPE",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols,
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(7.5, 7.5),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```

```{r}
tbl_perf %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, model, penalty, R2.est) %>%
  filter(scenario %in% "B" & penalty %in% c("combined", "-") & propzi == 0.5 & struczero == 0.33) %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = R2.est, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="p" ,
                   steps_y_base = -0.05, steps_y_height = 0.05, grid_rows = "a",
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "Averaged R2",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols,
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(0.25, 0.25),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```

```{r}
tbl_perf %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, model, penalty, CS.est) %>%
  filter(scenario %in% "B" & penalty %in% c("combined", "-") & propzi == 0.5 & struczero == 0.33) %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = CS.est, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="p" ,
                   steps_y_base = 0, steps_y_height = 0.05, grid_rows = "a",
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "Averaged CS",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols,
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(0.25, 0.25),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```


## ZI: high
```{r}
tbl_perf %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, model, penalty, RMSPE.est) %>%
  filter(scenario %in% "B" & penalty %in% c("combined", "-") & propzi == 0.75 & struczero == 0.33 & model != "oracle") %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = RMSPE.est, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="p" ,
                   steps_y_base = -2, steps_y_height = 0.5, grid_rows = "a",
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "Averaged RMSPE",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols,
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(7.5, 7.5),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```

```{r}
tbl_perf %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, model, penalty, R2.est) %>%
  filter(scenario %in% "B" & penalty %in% c("combined", "-") & propzi == 0.75 & struczero == 0.33) %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = R2.est, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="p" ,
                   steps_y_base = -0.05, steps_y_height = 0.05, grid_rows = "a",
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "Averaged R2",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols,
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(0.25, 0.25),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```

```{r}
tbl_perf %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, model, penalty, CS.est) %>%
  filter(scenario %in% "B" & penalty %in% c("combined", "-") & propzi == 0.75 & struczero == 0.33) %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = CS.est, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="p" ,
                   steps_y_base = 0, steps_y_height = 0.05, grid_rows = "a",
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "Averaged CS",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols,
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(0.25, 0.25),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```

:::


# Variable selection

## False discovery rate


:::{.panel-tabset}
Proportion of zero-inflation: 0.25

### Scenario A
```{r}
tbl_allsel %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, model, penalty, FPDR) %>%
  filter(scenario %in% "A" & penalty %in% c("combined", "-") & propzi == 0.25 & struczero == 0.33) %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = FPDR, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="p" , grid_rows = "a",
                   steps_y_base = 0, steps_y_height = 0.05,
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "FPDR",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols[-c(1,7)],
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(0.25, 0.25),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```

### Scenario B
```{r}
tbl_allsel %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, model, penalty, FPDR) %>%
  filter(scenario %in% "B" & penalty %in% c("combined", "-") & propzi == 0.25 & struczero == 0.33) %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = FPDR, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="p" , grid_rows = "a",
                   steps_y_base = 0, steps_y_height = 0.05,
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "FPDR",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols[-c(1,7)],
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(0.25, 0.25),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```
:::

:::{.panel-tabset}

Proportion of zero-inflation: 0.5

### Scenario A

```{r}
tbl_allsel %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, model, penalty, FPDR) %>%
  filter(scenario %in% "A" & penalty %in% c("combined", "-") & propzi == 0.5 & struczero == 0.33) %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = FPDR, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="p" , grid_rows = "a",
                   steps_y_base = 0, steps_y_height = 0.05,
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "FPDR",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols[-c(1,7)],
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(0.25, 0.25),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```


### Scenario B
```{r}
tbl_allsel %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, model, penalty, FPDR) %>%
  filter(scenario %in% "B" & penalty %in% c("combined", "-") & propzi == 0.5 & struczero == 0.33) %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = FPDR, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="p" , grid_rows = "a",
                   steps_y_base = 0, steps_y_height = 0.05,
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "FPDR",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols[-c(1,7)],
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(0.25, 0.25),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```
:::


:::{.panel-tabset}


### Scenario A

```{r}
tbl_allsel %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, model, penalty, FPDR) %>%
  filter(scenario %in% "A" & penalty %in% c("combined", "-") & propzi == 0.75 & struczero == 0.33) %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = FPDR, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="p" , grid_rows = "a",
                   steps_y_base = 0, steps_y_height = 0.05,
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "FPDR",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols[-c(1,7)],
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(0.25, 0.25),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```


### Scenario B
```{r}
tbl_allsel %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, model, penalty, FPDR) %>%
  filter(scenario %in% "B" & penalty %in% c("combined", "-") & propzi == 0.75 & struczero == 0.33) %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = FPDR, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="p" , grid_rows = "a",
                   steps_y_base = 0, steps_y_height = 0.05,
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "FPDR",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols[-c(1,7)],
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(0.25, 0.25),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```
:::

## True discovery rate


```{r}
tbl_allsel %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, model, penalty, TPDR) %>%
  filter(scenario %in% "A" & penalty %in% c("combined", "-") & propzi == 0.75 & struczero == 0.33) %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = TPDR, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="p" , grid_rows = "a",
                   steps_y_base = 0, steps_y_height = 0.05,
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "TPDR",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols[-c(1,7)],
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(0.25, 0.25),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```

```{r}
tbl_allsel %>%
  dplyr::select(scenario, a, n, p, epslvl, propzi, struczero, model, penalty, TPDR) %>%
  filter(scenario %in% "B" & penalty %in% c("combined", "-") & propzi == 0.75 & struczero == 0.33) %>%
  mutate(n = to_factor(n)) %>%
  arrange(model, penalty) %>%
  pivot_wider(id_cols = c(a, n, p, epslvl), values_from = TPDR, names_from = model) %>%
  nested_loop_plot(x = "n", steps = "epslvl", grid_cols ="p" , grid_rows = "a",
                   steps_y_base = 0, steps_y_height = 0.05,
                   steps_names = "Residual variance",
                   x_name = "Sample size", y_name = "TPDR",
                   spu_x_shift = 1.5,
                   grid_scales="free_y",
                   colors = ggcols[-c(1,7)],
                   steps_values_annotate = TRUE, steps_annotation_size = 3,
                   hline_intercept = 0,
                   y_expand_add = c(0.25, 0.25),
                   post_processing = list(
                       add_custom_theme = list(
                         text=element_text(size = 14),
                         axis.text.x = element_text(size = 14, angle = -90,vjust = 0.5),
                         legend.position="top")
                   )) 
```

